@page "/"
@using YouTubeRAGChatbot.Core.Services
@using YouTubeRAGChatbot.Core.Models
@using YouTubeRAGChatbot.Core.Configuration
@inject IRAGChatbotService ChatbotService
@inject IVectorDatabaseService VectorDatabase
@inject AppSettings Settings
@rendermode @(new InteractiveServerRenderMode())

<PageTitle>Chat - YouTube RAG Chatbot</PageTitle>

<div class="chat-container">
    <h2>üí¨ Chat with YouTube Videos</h2>
    
    @if (isLoading)
    {
        <div class="alert alert-info">
            <p>Loading vector database...</p>
        </div>
    }
    else if (loadError != null)
    {
        <div class="alert alert-danger">
            <p>@loadError</p>
            <p>Please add videos first or check your configuration.</p>
        </div>
    }
    else
    {
        <div class="chat-messages">
            @foreach (var message in messages)
            {
                <div class="message @message.Role">
                    <strong>@(message.Role == "user" ? "You" : "Bot"):</strong>
                    <div class="message-content">@message.Content</div>
                    <small class="text-muted">@message.Timestamp.ToString("HH:mm:ss")</small>
                </div>
            }
            
            @if (isThinking)
            {
                <div class="message assistant">
                    <strong>Bot:</strong>
                    <div class="message-content">ü§î Thinking...</div>
                </div>
            }
        </div>

        <div class="chat-input">
            <input type="text" 
                   class="form-control" 
                   placeholder="Ask a question about the videos..."
                   @bind="userInput"
                   @onkeypress="HandleKeyPress"
                   disabled="@isThinking" />
            <button class="btn btn-primary" 
                    @onclick="SendMessage"
                    disabled="@(isThinking || string.IsNullOrWhiteSpace(userInput))">
                Send
            </button>
            <button class="btn btn-secondary" @onclick="ClearChat">Clear</button>
        </div>
    }
</div>

<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 150px);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        margin-bottom: 20px;
        background-color: #f8f9fa;
    }

    .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 5px;
    }

    .message.user {
        background-color: #e3f2fd;
        text-align: right;
    }

    .message.assistant {
        background-color: #fff;
        border: 1px solid #dee2e6;
    }

    .message-content {
        margin: 5px 0;
        white-space: pre-wrap;
    }

    .chat-input {
        display: flex;
        gap: 10px;
    }

    .chat-input input {
        flex: 1;
    }
</style>

@code {
    private List<ChatMessage> messages = new();
    private string userInput = "";
    private bool isThinking = false;
    private bool isLoading = true;
    private string? loadError = null;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var dbPath = Path.GetFullPath(Settings.Storage.VectorDbDirectory);
            Console.WriteLine($"Loading vector database from: {dbPath}");
            await VectorDatabase.LoadFromFileAsync(dbPath);
            isLoading = false;
        }
        catch (Exception ex)
        {
            loadError = $"Failed to load vector database: {ex.Message}";
            isLoading = false;
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(userInput) || isThinking)
            return;

        var question = userInput;
        userInput = "";
        
        messages.Add(new ChatMessage 
        { 
            Role = "user", 
            Content = question 
        });

        isThinking = true;
        StateHasChanged();

        try
        {
            var response = await ChatbotService.ChatAsync(question, true);
            messages.Add(new ChatMessage 
            { 
                Role = "assistant", 
                Content = response 
            });
        }
        catch (Exception ex)
        {
            messages.Add(new ChatMessage 
            { 
                Role = "assistant", 
                Content = $"‚ùå Error: {ex.Message}" 
            });
        }
        finally
        {
            isThinking = false;
            StateHasChanged();
        }
    }

    private void ClearChat()
    {
        messages.Clear();
        userInput = "";
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessage();
        }
    }
}
